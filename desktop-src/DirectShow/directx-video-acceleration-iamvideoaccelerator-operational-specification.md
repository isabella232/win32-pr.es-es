---
description: Especificación operativa de aceleración de vídeo de DirectX IAMVideoAccelerator
ms.assetid: 25ee05d5-8554-4739-9122-e3c0255bf965
title: Especificación operativa de aceleración de vídeo de DirectX IAMVideoAccelerator
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 3360e18e91197f2a15a36fb112f0419b6382e915
ms.sourcegitcommit: d75fc10b9f0825bbe5ce5045c90d4045e3c53243
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/13/2021
ms.locfileid: "127061688"
---
# <a name="directx-video-acceleration-iamvideoaccelerator-operational-specification"></a>Especificación operativa de aceleración de vídeo de DirectX IAMVideoAccelerator

El mecanismo preciso de operación es el siguiente:

1.  Cada perfil de modo restringido definido en este documento tiene un GUID de Va de DirectX asociado que puede ser compatible con el [**IPin::QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) de un pin de entrada de bajada y se muestra en [**IAMVideoAccelerator::GetVideoAcceleratorGUIDs**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getvideoacceleratorguids).
2.  De forma similar, cada tipo de protocolo de cifrado para su uso con DirectX VA debe tener un GUID de tipo de protocolo de cifrado asociado que puede ser compatible con el [**IPin::QueryAccept**](/windows/desktop/api/Strmif/nf-strmif-ipin-queryaccept) e [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) de un pin de entrada de bajada y que se muestra en **IAMVideoAccelerator::GetVideoAcceleratorGUIDs.** El GUID "sin cifrado" DXVA NoEncrypt no se enviará en esta lista, ya que la compatibilidad con él es necesaria y, por \_ tanto, implícita.
3.  Después de llamar a [**IPin::ReceiveConnection**](/windows/desktop/api/Strmif/nf-strmif-ipin-receiveconnection) para intentar una conexión al pin de entrada de bajada, el [**elemento IAMVideoAcceleratorNotify::GetCreateVideoAcceleratorData**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoacceleratornotify-getcreatevideoacceleratordata) del descodificador devolverá un puntero a una estructura de datos CONNECTMode de DXVA que contenga la información del modo de conexión de \_ la conexión. Se llamará a [**IAMVideoAccelerator::GetCompBufferInfo**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-getcompbufferinfo) con pdwNumTypesCompBuffers = 16 y devolverá información de búfer comprimido en función de la convención de que el número de tipo de cada búfer (tal y como se define en la sección 3.4 de la especificación va de DirectX) se puede usar directamente como índice de base cero en la matriz de estructuras de datos \* **AMVACompBufferInfo** que se devuelve. Esto requiere que para cualquier tipo de búfer que no se use (incluido el tipo de búfer 0, puesto que no hay ningún uso definido de ese tipo de búfer), el controlador del acelerador proporcionará estructuras de datos AMVACompBufferInfo con algún tipo de valores de parámetro "ficticios" (como dwNumCompBuffers=0, dwWidthToCreate=0, dwHeightToCreate=0 y dwBytesToAllocate=0).
4.  Las indicaciones de función DXVA y los búferes de datos asociados se envían [**mediante IAMVideoAccelerator::Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). La función DXVA se indica en el parámetro dwFunction de la llamada. Las únicas funciones de DXVA que son relevantes para la inicialización son DXVA \_ ConfigQueryOrReplyFunc y DXVA \_ EncryptProtocolFunc.
    -   Si dwFunction contiene un elemento ConfigQueryOrReplyFunc de DXVA, el puntero lpPrivateInputData para pasar datos al acelerador en esta llamada debe apuntar a una estructura de datos de configuración, el puntero lpPrivateOutputData para recibir información del acelerador apuntará a un área donde se pueda colocar una estructura de datos de configuración alternativa o duplicada, el puntero pamvaBufferInfo para una matriz de \_ AMVABUFFERINFO será **NULL** y dwNumBuffers será cero. El valor HRESULT devuelto contiene la indicación S OK o S FALSE, E FAIL o E INVALIDARG o alguna otra indicación de error HRESULT en caso de que se produjese un problema grave en la ejecución del protocolo (por ejemplo, un parámetro de configuración no \_ \_ \_ \_ válido). Todas las llamadas a **IAMVideoAccelerator::Execute** para todos los usos de DXVA ConfigQueryOrReplyFunc precederán a todas las demás llamadas a \_ **IAMVideoAccelerator::Execute**.
    -   Si dwFunction contiene un elemento EncryptProtocolFunc de DXVA, el puntero lpPrivateInputData para pasar datos al acelerador en esta llamada debe apuntar a una estructura de datos del protocolo de cifrado que comience por DXVA EncryptProtocolHeader, El puntero lpPrivateOutputData para recibir información del acelerador debe apuntar a un área donde se puedan colocar los datos que el protocolo de cifrado (que comenzará por \_ \_ DXVA \_ EncryptProtocolHeader), el puntero pamvaBufferInfo de una matriz de AMVABUFFERINFO debe ser NULL y dwNumBuffers será cero. El HRESULT devuelto contiene S OK siempre y cuando el protocolo de cifrado funcione con normalidad y contenga E FAIL o E INVALIDARG u otra indicación de error HRESULT en caso de que se produjese un problema grave en la ejecución del \_ \_ \_ protocolo.

        Después de inicializar la operación de la manera anterior, la operación real del descodificador continúa de la siguiente manera:

5.  Se debe llamar a **IAMVideoAccelerator::BeginFrame** antes de enviar cualquier func de bDXVA con parámetros de búfer comprimidos que provocan escrituras en una superficie \_ de destino sin comprimir. El propósito de [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) en DirectX VA es asociar superficies de destino con valores de índice y notificar al controlador del acelerador de vídeo la intención de iniciar escribe una superficie para que el controlador pueda responder con una indicación de si la superficie está lista para sobrescribirse. La estructura **AMVABeginFrameInfo** pasada en **IAMVideoAccelerator::BeginFrame** debe contener un puntero pInputData a un único parámetro WORD wBeginPictureIndex que coincida con el índice de marco pasado a **IAMVideoAccelerator::BeginFrame** (y dwSizeInputData debe ser 2). Este es el índice que se va a usar en un búfer comprimido para escribir en la superficie (por ejemplo, para usarse como wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex). Cada llamada a **IAMVideoAccelerator::BeginFrame** se emparejará con una llamada correspondiente a [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) como se describe a continuación. Por ejemplo, si una imagen comprimida se descodifica y, a continuación, se combina alfa mediante la combinación de búfer a búfer de front-end con una imagen gráfica, habría una llamada a **IAMVideoAccelerator::BeginFrame** antes de descodificar la imagen comprimida en una superficie especificada en wDecodedPictureIndex, a continuación, una llamada a **IAMVideoAccelerator::EndFrame** después de pasar todos los búferes comprimidos usados para descodificar la imagen, después una segunda llamada a **IAMVideoAccelerator::BeginFrame** antes de ejecutar una combinación de combinación alfa del origen gráfico con la imagen descodificada en una superficie especificada en wBlendedDestinationIndex y, a continuación, una segunda llamada a **IAMVideoAccelerator::EndFrame** después de la operación de combinación alfa. El puntero pOutputData de AMVABeginFrameInfo debe ser **NULL** (y dwSizeOutputData debe ser "0"). El HRESULT devuelto por **IAMVideoAccelerator::BeginFrame** debe ser:
    -   S \_ Ok si la superficie sin comprimir está disponible y lista para su uso.
    -   E PENDING si la superficie sin comprimir aún no está disponible para su uso, pero estará disponible pronto (si la superficie sin comprimir se está leyendo para mostrarse y la lectura o presentación de la superficie aún no se ha \_ completado).
    -   E FAIL o E INVALIDARG alguna otra indicación de error solo si se detecta un error de protocolo o formato de datos (por ejemplo, un valor incorrecto de dwSizeInputData o un \_ valor pOutputData que no \_ sea **NULL).**
6.  Las indicaciones de función DXVA y los búferes de datos asociados se envían **mediante IAMVideoAccelerator::Execute**. Se puede indicar más de un valor func bDXVA en la misma llamada a \_ [**IAMVideoAccelerator::Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute). Los valores de bDXVA Func se empaquetarán en el parámetro dwFunction de la llamada, con el primer comando de función en los ocho MSB, el comando siguiente en los ocho bits siguientes, y así sucesivamente, con los bits restantes con \_ ceros. El valor 0xFF para bDXVA Func indica que el func bDXVA se extiende \_ a dos o cuatro \_ bytes. Si el segundo byte también 0xFF, esto indica que bDXVA \_ Func se extiende a cuatro bytes. Si los cuatro bits superiores del tercer byte son 0xF o 0x0, esto indica que bDXVA Func contiene una \_ configQueryOrReplyFunc de DXVA o \_ \_ DXVA EncryptProtocolFunc. Los comandos de varios bytes no deben indicar la continuación después del final de dwFunction. El descodificador debe tener cuidado para asegurarse de que no haya dependencias secuenciales entre los distintos valores func de bDXVA especificados en la misma llamada a IAMVideoAccelerator::Execute y que todas las posibles condiciones de carrera (por ejemplo, entre la descodificación de imágenes y la combinación de sub picture, las llamadas adecuadas a \_ **IAMVideoAccelerator::BeginFrame** y [**IAMVideoAccelerator::QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) antes de las llamadas subsiguientes a **IAMVideoAccelerator::Execute** evitan la carga de sub picture y la combinación de sub picture,  entre otras.
    -   Si dwFunction contiene un elemento ConfigQueryOrReplyFunc de DXVA, el puntero lpPrivateInputData para pasar datos al acelerador en esta llamada debe apuntar a una estructura de datos de configuración, el puntero lpPrivateOutputData para recibir información del acelerador apuntará a un área donde se pueda colocar una estructura de datos de configuración alternativa o duplicada, el puntero pamvaBufferInfo para una matriz de \_ AMVABUFFERINFO será **NULL** y dwNumBuffers será cero. El valor HRESULT devuelto contiene la indicación S OK o S FALSE en respuesta a la consulta, o E FAIL o E INVALIDARG alguna otra indicación de error HRESULT en caso de un problema grave en la ejecución del protocolo (por ejemplo, un parámetro \_ \_ \_ \_ invalid.configuration). Todas las llamadas a **IAMVideoAccelerator::Execute** para todos los usos de DXVA ConfigQueryOrReplyFunc precederán a todas las demás llamadas a \_ **IAMVideoAccelerator::Execute**.
    -   Si dwFunction contiene un elemento EncryptProtocolFunc de DXVA, el puntero lpPrivateInputData para pasar datos al acelerador en esta llamada debe apuntar a una estructura de datos del protocolo de cifrado que comience por DXVA EncryptProtocolHeader, El puntero lpPrivateOutputData para recibir información del acelerador debe apuntar a un área donde se puedan colocar los datos que el protocolo de cifrado (que comenzará por \_ \_ DXVA \_ EncryptProtocolHeader), el puntero pamvaBufferInfo de una matriz de AMVABUFFERINFO debe ser NULL y dwNumBuffers será cero. El HRESULT devuelto contiene S OK siempre y cuando el protocolo de cifrado funcione con normalidad y contenga E FAIL o E INVALIDARG u otra indicación de error HRESULT en caso de que se produjese un problema grave en la ejecución del \_ \_ \_ protocolo.
    -   Si dwFunction no contiene un elemento \_ ConfigQueryOrReplyFunc o DXVA EncryptProtocolFunc de DXVA, el puntero lpPrivateInputData para pasar datos al acelerador apuntará a una lista de descripción del \_ búfer. Las cuatro primeras entradas de la estructura de lista de descripción del búfer para cada búfer (dwTypeIndex, dwBufferIndex, dwDataOffset y dwDataSize) deben ser iguales a las de la estructura de datos AMVABUFFERINFO para el mismo búfer. Si bDXVA Func es igual a "1" se especifica en dwFunction y bPicReadbackRequests es "1", El puntero lpPrivateOutputData para recibir información del acelerador debe apuntar a un área de memoria persistente (por ejemplo, el montón) que se rellenará con datos de macrobloque de lectura hacia atrás del acelerador (no se garantiza que estos datos estarán presentes hasta \_ **que IAMVideoAccelerator::QueryRenderStatus** para escribir en el mismo búfer de parámetros de imagen indica S OK como se describe en el elemento \_ 10 a continuación). De lo contrario, el puntero lpPrivateOutputData para recibir información del acelerador debe apuntar a un único DWORD que se establecerá en uno de los siguientes valores de indicación (especialmente útil para notificar errores de secuencia de bits en la operación VLD fuera del host).

        | Value | Descripción                                     |
        |-------|-------------------------------------------------|
        | 0     | Ejecución correcta.                                   |
        | 1     | Se encontró un problema menor en el formato de datos.       |
        | 2     | Se encontró un problema significativo en el formato de datos. |
        | 3     | Se encontró un problema grave en el formato de datos.      |
        | 4     | Se encontró otro problema grave.               |

        

         

        Si se indica cualquier tipo de problema "grave", el descodificador de software debe dejar de operar las funciones a menos que se puedan tomar medidas correctivas. El host no leerá estos datos devueltos por el acelerador hasta que se haya completado la representación del búfer para la imagen, como puede probar [**IAMVideoAccelerator::QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus). El HRESULT devuelto contiene S OK siempre y cuando la operación de interfaz funcione con normalidad y pueda devolver E FAIL o E INVALIDARG o alguna otra indicación de error HRESULT en caso de un \_ \_ problema \_ grave.

7.  El búfer de parámetros de decoding de imagen debe estar entre los primeros búferes enviados para lacodización de cada imagen al usar [**IAMVideoAccelerator::Execute**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-execute) con bDXVA Func igual a "1", y todos los búferes para la decodización de una imagen en una secuencia de bits se enviarán antes que los búferes para la decodización de imágenes \_ posteriores. Si se envía un búfer de comandos de control de macroblock, se enviará un búfer de datos de diferencia residual correspondiente (que contiene datos para los mismos bloques de macro) con la misma **llamada IAMVideoAccelerator::Execute.**
8.  Se llamará a [**IAMVideoAccelerator::EndFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-endframe) después de que se hayan enviado todos los búferes comprimidos que provocarán la creación del contenido de salida en una superficie no comprimida especificada (resultado de las operaciones especificadas para wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex). El propósito de esta llamada a **IAMVideoAccelerator::EndFrame** es notificar al hardware del acelerador de vídeo que se han enviado todos los datos necesarios para la operación especificada. El puntero a los datos que se envían de bajada a través de **IAMVideoAccelerator::EndFrame** debe apuntar a un único elemento wEndPictureIndex de WORD que contiene el índice del marco que está finalizando. Este parámetro debe coincidir con el valor wBeginPictureIndex especificado en la llamada anterior a [**IAMVideoAccelerator::BeginFrame**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-beginframe) antes del envío de los búferes comprimidos pertinentes. Después de una llamada a **IAMVideoAccelerator::EndFrame**, la superficie sin comprimir con el índice wEndPictureIndex no se encontrará en wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex de ninguna imagen hasta después de que se emita otra llamada a **IAMVideoAccelerator::BeginFrame** para anunciar que esto se producirá y se ha devuelto un S OK como \_ resultado. Sin embargo, ese índice de superficie de destino puede producirse en comandos de acceso de lectura posteriores, como wForwardRefPictureIndex, wBackwardRefPictureIndex, wPicResampleSourcePicIndex o bRefPicSelect \[ i \] . El HRESULT devuelto por **IAMVideoAccelerator::EndFrame** será S OK a menos que haya algún tipo de formato de datos o error de protocolo, en cuyo caso puede ser \_ E FAIL, E INVALIDARG u otra indicación \_ \_ de error.
9.  En el caso de la codificación basada en campos (por ejemplo, en secuencias de bits MPEG-2), no habrá una asignación uno a uno de imágenes funcionales en la secuencia de bits a superficies sin comprimir en la interfaz del acelerador. Al descodificar imágenes de campo en un flujo de bits MPEG-2, habrá dos "imágenes" descodificadas para generar una superficie de salida completa sin comprimir. En la definición de la interfaz de VA de DirectX, cada fotograma corresponde a cada uso de wDecodedPictureIndex, wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex. Por lo tanto, se requieren dos pares de llamadas a **IAMVideoAccelerator::BeginFrame** y **IAMVideoAccelerator::EndFrame** para lacoding de imágenes de campo en superficies sin comprimir de salida.
10. Una llamada a [**IAMVideoAccelerator::QueryRenderStatus**](/previous-versions/windows/desktop/api/videoacc/nf-videoacc-iamvideoaccelerator-queryrenderstatus) con dwFlags igual a cero que se produce en algún momento después de una llamada a **IAMVideoAccelerator::EndFrame** con un wEndPictureIndex determinado y comprueba el estado de un búfer enviado que contenía wEndPictureIndex en wDecodedPictureIndex. wDeblockedPictureIndex, wBlendedDestinationIndex o wPicResampleDestPicIndex devolverá una indicación S OK si se han completado todas las operaciones para escribir los datos en la superficie sin comprimir y devolverá E PENDING si la operación aún no se ha \_ \_ completado. Se puede devolver E FAIL, E INVALIDARG u otra indicación de \_ error en caso de error de \_ protocolo.

## <a name="related-topics"></a>Temas relacionados

<dl> <dt>

[Asignación de aceleración de vídeo de DirectX a IAMVideoAccelerator](mapping-directx-video-acceleration-to-iamvideoaccelerator.md)
</dt> </dl>

 

 



